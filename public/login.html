<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles/accounts.css" />
    <title>Log In - King Fidel</title>
  </head>
  <body>
    <div class="container">
      <form id="loginForm">
        <h2>Login</h2>
        <input
          id="temp-email"
          name="email"
          type="email"
          placeholder="Email"
          required
        />
        <input
          name="password"
          type="password"
          placeholder="Password"
          required
        />
        <button type="submit">Login</button>
        <a id="forgot-link" href="#">Forgot password?</a>
        <p>Don't have an account? <a href="/signup">Sign up</a></p>
      </form>
    </div>
    <script src="/scripts/utils.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const redirectParam = params.get("redirect") || "/";
      document
        .getElementById("forgot-link")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const email_value = document.getElementById("temp-email").value;
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email_value.trim())) {
            return showNotification("Enter a valid email address", "error");
          }
          sessionStorage.setItem("temp-email", email_value);
          window.location.href = "/forgot";
        });
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const body = Object.fromEntries(new FormData(e.target));
          body.redirect = redirectParam;
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (data.status === "ok") {
            // non-subscribed
            const me = await fetch("/me")
              .then((r) => r.json())
              .catch(() => null);
            if (data.status === "ok") {
              location.href = ( data.redirect.startsWith("/subscribe") && ( me.role === "admin" || me.isSubscribed )) ? "/" : data.redirect;
            }
          } else if (data.status === "otp_required") {
            showOtpField(data.email);
          } else {
            showNotification("Login Error: " + (data.message || ""), "error");
          }
        });

      function showOtpField(email) {
        let otpDiv = document.getElementById("otpDiv");
        if (!otpDiv) {
          otpDiv = document.createElement("div");
          otpDiv.id = "otpDiv";
          otpDiv.innerHTML = `
        <input type="text" id="otpInput" placeholder="Enter OTP" required>
        <button id="otpSubmit" type="button">Verify OTP</button>
      `;
          document.getElementById("loginForm").appendChild(otpDiv);
          document
            .getElementById("otpSubmit")
            .addEventListener("click", async () => {
              const otp = document.getElementById("otpInput").value.trim();
              const res = await fetch("/api/verify-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, otp }),
              });
              if (res.ok) {
                location.href = "/";
              } else {
                await fetch("/logout", { method: "POST" }); // force logout
                showNotification("Invalid or expired OTP", "error");
              }
            });
        }
      }
    </script>
  </body>
</html>
